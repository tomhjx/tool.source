{{ $_hugo_config := `{ "version": 1 }` }}
{{ $blockID := printf "mermaideditorcontainer%d" .Ordinal }}
{{ $nowDate := now.Format "2006-01-02 15:04:05" }}

<div class="container text-left">
        <div class="row">
          <div class="col">
                <textarea id="{{ $blockID  }}" class="form-control border w-100" style="height: 200px;" ></textarea>
                <a class="btn btn-outline-primary" href="###" target="_blank" id="{{ $blockID  }}LinkToView" >Link to view</a>
                <button type="button" class="btn btn-secondary" id="{{ $blockID  }}LinkToIMG" >Link to Image</button>
                <button type="button" class="btn btn-secondary" id="{{ $blockID  }}LinkToSVG" >Link to SVG</button>
                <button type="button" class="btn btn-secondary" id="{{ $blockID  }}CopyToIMG" >Copy Image</button>
                <!-- <button type="button" class="btn btn-secondary" id="{{ $blockID  }}DownloadPNG" >Download PNG</button> -->
                <a class="btn btn-outline-primary" id="{{ $blockID  }}DownloadPNG" href="javascript:;" download="a.png" >Download PNG</a>
                <!-- <button type="button" class="btn btn-secondary" id="{{ $blockID  }}DownloadSVG" >Download SVG</button> -->
                <a class="btn btn-outline-primary" id="{{ $blockID  }}DownloadSVG" href="javascript:;" download="a.svg"  >Download SVG</a>
          </div>
          <div id="{{ $blockID  }}Output" class="col"></div>

        </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script >
    mermaid.initialize({startOnLoad:false});
    $(function(){
        console.log("{{ $nowDate }}")

        var blockID = "{{ $blockID  }}";
        var input = document.getElementById(blockID);
        var output = document.getElementById(blockID+'Output');
        var linkToView = document.getElementById(blockID+'LinkToView');
        var downloadSVG = $('#'+blockID+'DownloadSVG');
        var downloadPNG = $('#'+blockID+'DownloadPNG');
        var svg = null
        var canvas = null

        // define

        var img = new Image();
        img.crossOrigin="anonymous";
        img.onload=function(){
                linkToView.href = img.src
                console.log("img.naturalWidth="+img.naturalWidth)
                console.log("img.naturalHeight="+img.naturalHeight)
                console.log("img.width="+img.width)
                console.log("img.height="+img.height)
        }

        function draw() {
                if (!canvas) {
                    canvas = document.createElement('canvas');
                }       
                var imgH=img.height;
                var imgW=img.width;
                canvas.width = imgW;
                canvas.height = imgH;
                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
                return canvas;
        }

        // bind


        input.onkeyup = function() {
                mermaid.mermaidAPI.render('theGraph', input.value, function(svgCode) {
                        output.innerHTML = svgCode;
                        svg = output.querySelector('svg');
                        var svgData = new XMLSerializer().serializeToString(svg);
                        var svgDataBase64 = btoa(unescape(encodeURIComponent(svgData)))
                        var svgDataUrl = `data:image/svg+xml;charset=utf-8;base64,${svgDataBase64}`
                        // var blob = new Blob([svgData], { type: 'image/svg+xml' });
                        // var win = window.URL || window.webkitURL || window;
                        // var url = win.createObjectURL(blob);
                        img.src = svgDataUrl
                        console.log("svg.getBoundingClientRect.width="+svg.getBoundingClientRect().width)
                        console.log("svg.getBoundingClientRect.height="+svg.getBoundingClientRect().height)
                        console.log("svg.getBBox.width="+svg.getBBox().width)
                        console.log("svg.getBBox.height="+svg.getBBox().height)
                        img.width = svg.getBBox().width
                        img.height = svg.getBBox().height

                });
        }

        downloadSVG.click(function(){
                downloadSVG.attr("href", img.src)
        });

        downloadPNG.click(function(){
                downloadPNG.attr("href", draw().toDataURL('image/png'))
                downloadPNG.attr("download", self.crypto.randomUUID()+'.png')
        });

        // $('#'+blockID+'LinkToView').click(function(){
                // var svgData = new XMLSerializer().serializeToString(svg);
                // var blob = new Blob([svgData], { type: 'image/svg+xml' });

                // var win = window.URL || window.webkitURL || window;
                // var url = win.createObjectURL(blob);

                // var img = new Image(); // alt: document.createElement('img')
                // loadImage(img, url, function(){

                //         var imgH=img.height; // original file height
                //         var imgW=img.width; // original file width
                //         var scaleBy = 2;
                //         const scale = window.devicePixelRatio*2;

                //         var _canvas = document.createElement('canvas');
                //         _canvas.width = imgW*scaleBy;
                //         _canvas.height = imgH*scaleBy;
                //         _canvas.style.width = imgW+"px" ;
                //         _canvas.style.hight = imgH+"px";

                //         var _ctx = _canvas.getContext("2d");
                //         // _ctx.scale(scaleBy,scaleBy);
                //         _ctx.drawImage(img, 0, 0);

                //         // Note: fileName = original .svg filename     dwnLink.download=fileName.substr(0,fileName.lastIndexOf('.'))+'.png';
                //         window.open(_canvas.toDataURL('image/png'))
                // });

                // var imgH=img.height; // original file height
                // var imgW=img.width; // original file width
                // var _canvas = document.createElement('canvas');
                // _canvas.width = imgW;
                // _canvas.height = imgH;
                // var _ctx = _canvas.getContext("2d");
                // _ctx.drawImage(img, 0, 0, imgW, imgH);
                // console.log("canvas toDataURL. ")
                // console.log(_canvas.toDataURL('image/png'))
        // });


        // svg to png
        // https://mybyways.com/blog/convert-svg-to-png-using-your-browser
    })

</script>

