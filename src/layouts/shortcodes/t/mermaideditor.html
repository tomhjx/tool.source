{{ $_hugo_config := `{ "version": 1 }` }}
{{ $blockID := printf "mermaideditorcontainer%d" .Ordinal }}

<div class="container text-left">
        <div class="row">
          <div class="col">
                <textarea id="{{ $blockID  }}" class="border w-100" style="height: 200px;" ></textarea>
                <button type="button" class="btn btn-secondary" id="{{ $blockID  }}LinkToView" >Link to view</button>
                <button type="button" class="btn btn-secondary" id="{{ $blockID  }}LinkToIMG" >Link to Image</button>
                <button type="button" class="btn btn-secondary" id="{{ $blockID  }}LinkToSVG" >Link to SVG</button>
                <button type="button" class="btn btn-secondary" id="{{ $blockID  }}CopyToIMG" >Copy Image</button>
                <button type="button" class="btn btn-secondary" id="{{ $blockID  }}DownloadPNG" >Download PNG</button>
                <button type="button" class="btn btn-secondary" id="{{ $blockID  }}DownloadSVG" >Download SVG</button>
          </div>
          <div id="{{ $blockID  }}Output" class="col"></div>

        </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script >
    mermaid.initialize({startOnLoad:false});
    $(function(){
        console.log("v2023-02-27 00:59:53")
        var blockID = "{{ $blockID  }}";
        var input = document.getElementById(blockID);
        var output = document.getElementById(blockID+'Output');
        var svgData = '';

        input.onkeyup = function() {
                mermaid.mermaidAPI.render('theGraph', input.value, function(svgCode) {
                        svgData = output.innerHTML = svgCode;
                });
        }

        function loadImage(onload) {
                var img = new Image(); // alt: document.createElement('img')
                img.addEventListener('load', onload);
                img.src = url;
        }


        $('#'+blockID+'DownloadPNG').click(function(){
                console.log('click DownloadPNG.')
        });

        $('#'+blockID+'LinkToView').click(function(){
                var DOMURL = window.URL || window.webkitURL || window;
                var b64str = DOMURL.createObjectURL(svgData);

                var _img = loadImage(b64str, function(){

                        var imgH=_img.naturalHeight; // original file height
                var imgW=_img.naturalWidth; // original file width
                const scale = window.devicePixelRatio*2;

                var _canvas = document.createElement('canvas');
                _canvas.width=imgW;
                _canvas.height=imgH;
                var _ctx = _canvas.getContext('2d');
                _canvas['style']['width'] = `${Math.round(imgW/scale)}px`;
                _canvas['style']['height'] = `${Math.round(imgH/scale)}px`;
                _canvas['style']['margin'] = '0';
                _canvas['style']['padding'] = '0';
                _ctx.scale(scale, scale);
                _ctx.drawImage(_img, 0, 0, Math.round(imgW/scale), Math.round(imgH/scale));

                // Note: fileName = original .svg filename     dwnLink.download=fileName.substr(0,fileName.lastIndexOf('.'))+'.png';
                window.open(_canvas.toDataURL())

                });

        });


        // svg to png
        // https://javascript.plainenglish.io/3-steps-to-convert-svgs-to-image-file-formats-png-in-javascript-5394bf837185
    })

</script>

